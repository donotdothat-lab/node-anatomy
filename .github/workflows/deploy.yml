name: Deploy to Home Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sync files to Playground
        run: |
          # 1. ë°°í¬í•  í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
          mkdir -p ~/playground/node-anatomy

          # 2. rsyncë¡œ íŒŒì¼ ë™ê¸°í™” (ê¸°ì¡´ íŒŒì¼ ë®ì–´ì“°ê¸°)
          # .git, node_modules ë“± ë¶ˆí•„ìš”í•œ ê±´ ì œì™¸
          rsync -av --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'node_modules' \
            --exclude '.pnpm-store' \
            --exclude 'dist' \
            --exclude '.env' \
            ./ ~/playground/node-anatomy/

          echo "ğŸ‰ ë°°í¬ ì„±ê³µ! ì½”ë“œê°€ ~/playground/node-anatomy ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: Install Dependencies & Restart
        run: |
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          # [-e CI=true] ì˜µì…˜ ì¶”ê°€: ëŒ€í™”í˜• ì§ˆë¬¸ ì—†ì´ ê°•ì œ ì§„í–‰ ëª¨ë“œ í™œì„±í™”
          docker exec -e CI=true anatomy-api-dev pnpm install

          echo "ğŸ”„ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì¤‘..."
          docker restart anatomy-api-dev

          echo "ğŸš€ ë°°í¬ ì™„ë£Œ!"
